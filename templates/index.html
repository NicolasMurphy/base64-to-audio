<!DOCTYPE html>
<html>
  <head>
    <title>Base64 to Audio</title>
  </head>
  <body>
    <h1>Base64 to Audio Generator</h1>

    <textarea
      id="textInput"
      rows="10"
      cols="80"
      placeholder="Enter Base64 here..."
    ></textarea
    ><br /><br />

    <button onclick="analyzeInput()">Analyze Input</button>
    <button onclick="generateAudio()">Generate Audio</button>
    <button onclick="loadExample('random')">Random Audio Data</button>
    <button onclick="loadExample('pattern')">Pattern Audio</button><br /><br />

    <div id="output"></div>

    <audio id="audioPlayer" controls style="display: none"></audio>

    <script>
      async function analyzeInput() {
        const text = document.getElementById("textInput").value.trim();
        const output = document.getElementById("output");

        if (!text) {
          output.innerHTML =
            '<p style="color: red;">Please enter some Base64 text!</p>';
          return;
        }

        try {
          const response = await fetch("/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: text }),
          });

          const result = await response.json();
          displayAnalysis(result);
        } catch (error) {
          output.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
        }
      }

      function displayAnalysis(result) {
        const output = document.getElementById("output");
        let html = "<h3>Analysis Results:</h3>";

        if (result.error) {
          html += `<p style="color: red;"><strong>Error:</strong> ${result.error}</p>`;
          if (result.suggestions) {
            html += "<p><strong>Suggestions:</strong></p><ul>";
            result.suggestions.forEach((s) => (html += `<li>${s}</li>`));
            html += "</ul>";
          }
          output.innerHTML = html;
          return;
        }

        if (result.is_wav) {
          html += `<p style="color: green;"><strong>${result.message}</strong></p>`;
          html += "<p><strong>Stats:</strong></p><ul>";
          Object.entries(result.stats).forEach(([key, value]) => {
            html += `<li>${key}: ${value}</li>`;
          });
          html += "</ul>";
        } else {
          if (result.valid) {
            html +=
              '<p style="color: green;"><strong>✓ Input looks okay for audio conversion</strong></p>';
          } else {
            html +=
              '<p style="color: orange;"><strong>⚠ Issues found with your input:</strong></p>';
          }

          if (result.issues && result.issues.length > 0) {
            html += "<p><strong>Issues:</strong></p><ul>";
            result.issues.forEach(
              (issue) => (html += `<li style="color: red;">${issue}</li>`)
            );
            html += "</ul>";
          }

          if (result.warnings && result.warnings.length > 0) {
            html += "<p><strong>Warnings:</strong></p><ul>";
            result.warnings.forEach(
              (warning) =>
                (html += `<li style="color: orange;">${warning}</li>`)
            );
            html += "</ul>";
          }

          if (result.suggestions && result.suggestions.length > 0) {
            html += "<p><strong>Suggestions:</strong></p><ul>";
            result.suggestions.forEach(
              (suggestion) =>
                (html += `<li style="color: blue;">${suggestion}</li>`)
            );
            html += "</ul>";
          }

          if (result.facts && result.facts.length > 0) {
            html += "<p><strong>Technical Details:</strong></p><ul>";
            result.facts.forEach((fact) => (html += `<li>${fact}</li>`));
            html += "</ul>";
          }

          if (result.stats) {
            html += "<p><strong>Stats:</strong></p><ul>";
            Object.entries(result.stats).forEach(([key, value]) => {
              html += `<li>${key}: ${value}</li>`;
            });
            html += "</ul>";
          }
        }

        output.innerHTML = html;
      }

      async function generateAudio() {
        const text = document.getElementById("textInput").value.trim();
        const output = document.getElementById("output");
        const audioPlayer = document.getElementById("audioPlayer");

        if (!text) {
          output.innerHTML =
            '<p style="color: red;">Please enter some Base64 text!</p>';
          return;
        }

        try {
          output.innerHTML = "<p>Generating audio...</p>";

          const response = await fetch("/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: text }),
          });

          if (response.ok) {
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);

            audioPlayer.src = audioUrl;
            audioPlayer.style.display = "block";

            if (audioPlayer.dataset.prevUrl) {
              URL.revokeObjectURL(audioPlayer.dataset.prevUrl);
            }
            audioPlayer.dataset.prevUrl = audioUrl;

            output.innerHTML =
              '<p style="color: green;">✓ Audio generated successfully!</p>';
          } else {
            // Handle both JSON and text error responses
            let errorMessage;
            try {
              const errorJson = await response.json();
              errorMessage = errorJson.error || "Unknown error";
            } catch {
              errorMessage = await response.text();
            }
            output.innerHTML = `<p style="color: red;">Error: ${errorMessage}</p>`;
          }
        } catch (error) {
          output.innerHTML = `<p style="color: red;">Network error: ${error.message}</p>`;
        }
      }

      function loadExample(type) {
        const textarea = document.getElementById("textInput");
        const output = document.getElementById("output");

        try {
          if (type === "random") {
            // Generate random bytes for 5 seconds of audio
            const audioBytes = new Uint8Array(441000); // 5 seconds * 44100 samples/sec * 2 bytes/sample

            // Fill with random data using Math.random (crypto.getRandomValues has 65k limit)
            for (let i = 0; i < audioBytes.length; i++) {
              audioBytes[i] = Math.floor(Math.random() * 256);
            }

            // Convert to Base64
            let binaryString = "";
            for (let i = 0; i < audioBytes.length; i++) {
              binaryString += String.fromCharCode(audioBytes[i]);
            }
            textarea.value = btoa(binaryString);
            output.innerHTML = "<p>Loaded 5 seconds of random audio data!</p>";
          } else if (type === "pattern") {
            // Generate a 440Hz sine wave for 3 seconds
            const duration = 3; // seconds
            const sampleRate = 44100;
            const frequency = 440; // Hz
            const totalSamples = duration * sampleRate;
            const audioBytes = new Uint8Array(totalSamples * 2); // 16-bit = 2 bytes per sample

            for (let i = 0; i < totalSamples; i++) {
              // Generate sine wave sample
              const sample = Math.sin(
                (2 * Math.PI * frequency * i) / sampleRate
              );
              // Scale to 16-bit range
              const scaledSample = Math.floor(sample * 32767);

              // Convert to little-endian 16-bit
              const byteIndex = i * 2;
              audioBytes[byteIndex] = scaledSample & 0xff; // Low byte
              audioBytes[byteIndex + 1] = (scaledSample >> 8) & 0xff; // High byte
            }

            // Convert to Base64
            let binaryString = "";
            for (let i = 0; i < audioBytes.length; i++) {
              binaryString += String.fromCharCode(audioBytes[i]);
            }
            textarea.value = btoa(binaryString);
            output.innerHTML =
              "<p>Loaded 3 seconds of 440Hz sine wave data!</p>";
          }

          // Auto-analyze after loading
          setTimeout(analyzeInput, 100);
        } catch (error) {
          output.innerHTML = `<p style="color: red;">Error generating example: ${error.message}</p>`;
        }
      }
    </script>

    <hr />
    <h3>How This Works:</h3>
    <p>
      <strong>Analyze Input:</strong> Shows you technical details about your
      Base64 data for audio conversion
    </p>
    <p>
      <strong>Generate Audio:</strong> Converts your Base64 to a playable audio
      file - any data makes sound! (30 second limit)
    </p>
    <p>
      <strong>Examples:</strong> Try random data or patterns to hear different
      audio effects
    </p>
  </body>
</html>
